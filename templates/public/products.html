{% extends "public/base.html" %}

{% block title %}{% if current_category_name %}{{ current_category_name }}{% elif is_zhtw %}{{ t.all_products }}{% else %}All Products{% endif %} | Warpmonger{% endblock %}

{% block meta_description %}Browse our selection of {% if current_category_name %}{{ current_category_name|lower }} action figures{% else %}premium action figures and collectibles{% endif %}. Find the perfect collectible figures with fast shipping and great prices.{% endblock %}

{% block content %}
<div class="container">
    <div class="products-page">
        <aside class="products-sidebar">
            <h3>{{ t.filters }}</h3>
            <div class="filters">
                <label class="filter-checkbox">
                    <input type="checkbox" id="filter-preorder" {% if show_pre_order %}checked{% endif %}
                           onchange="toggleFilter('pre_order')">
                    {{ t.pre_order }}
                </label>
                <label class="filter-checkbox">
                    <input type="checkbox" id="filter-onsale" {% if show_on_sale %}checked{% endif %}
                           onchange="toggleFilter('on_sale')">
                    {{ t.on_sale }}
                </label>
                <label class="filter-checkbox">
                    <input type="checkbox" id="filter-newarrival" {% if show_new_arrival %}checked{% endif %}
                           onchange="toggleFilter('new_arrival')">
                    {{ t.new_arrivals }}
                </label>
                <label class="filter-checkbox">
                    <input type="checkbox" id="filter-instock" {% if show_in_stock %}checked{% endif %}
                           onchange="toggleFilter('in_stock')">
                    {{ t.in_stock }}
                </label>
            </div>

            <h3 style="margin-top: 2rem;">{{ t.categories }}</h3>
            <ul class="category-list">
                <li><a href="{{ url_prefix }}/products{% if show_pre_order or show_on_sale or show_new_arrival or show_in_stock %}?{% endif %}{% if show_pre_order %}pre_order=true{% endif %}{% if show_on_sale %}{% if show_pre_order %}&{% endif %}on_sale=true{% endif %}{% if show_new_arrival %}{% if show_pre_order or show_on_sale %}&{% endif %}new_arrival=true{% endif %}{% if show_in_stock %}{% if show_pre_order or show_on_sale or show_new_arrival %}&{% endif %}in_stock=true{% endif %}" {% if not current_category %}class="active"{% endif %}>{{ t.all_products }}</a></li>
                {% for category in categories %}
                <li>
                    <a href="{{ url_prefix }}/products?category={{ category.slug }}{% if show_pre_order %}&pre_order=true{% endif %}{% if show_on_sale %}&on_sale=true{% endif %}{% if show_new_arrival %}&new_arrival=true{% endif %}{% if show_in_stock %}&in_stock=true{% endif %}"
                       {% if current_category == category.slug %}class="active"{% endif %}>
                        {{ category.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>

            <script>
            function toggleFilter(filterType) {
                const url = new URL(window.location);
                const checkbox = document.getElementById(`filter-${filterType.replace('_', '')}`);

                // GA4: Track filter applied
                if (typeof gtag === 'function') {
                    gtag('event', 'filter_applied', {
                        filter_type: filterType,
                        filter_value: checkbox.checked ? 'true' : 'false'
                    });
                }

                if (checkbox.checked) {
                    url.searchParams.set(filterType, 'true');
                } else {
                    url.searchParams.delete(filterType);
                }

                window.location.href = url.toString();
            }

            function changeSort(sortValue) {
                // GA4: Track sort applied
                if (typeof gtag === 'function') {
                    gtag('event', 'filter_applied', {
                        filter_type: 'sort',
                        filter_value: sortValue
                    });
                }

                const url = new URL(window.location);
                if (sortValue === 'default') {
                    url.searchParams.delete('sort');
                } else {
                    url.searchParams.set('sort', sortValue);
                }
                window.location.href = url.toString();
            }
            </script>
        </aside>

        <div class="products-main">
            <div class="products-header">
                {% if current_search %}
                <h1>{{ t.search_results }}</h1>
                <p class="search-query">{{ t.showing_results_for }} <strong>"{{ current_search }}"</strong></p>
                <p>{{ products|length }} {{ t.products_found }}</p>
                {% if products|length > 0 %}
                <a href="{{ url_prefix }}/products" class="clear-search">{{ t.clear_search }}</a>
                {% endif %}
                {% elif current_tag %}
                <h1>{{ t.tag_label }}: {{ current_tag }}</h1>
                <p>{{ products|length }} {{ t.products_found }}</p>
                <a href="{{ url_prefix }}/products" class="clear-search">{{ t.clear_filter }}</a>
                <a href="{{ url_prefix }}/tags" class="clear-search" style="margin-left: 1rem;">{{ t.browse_all_tags }}</a>
                {% else %}
                <h1>{% if current_category_name %}{{ current_category_name }}{% else %}{{ t.all_products }}{% endif %}</h1>
                <p>{{ products|length }} {{ t.products_found }}</p>
                {% endif %}

            </div>

            <div class="sort-controls">
                <button class="sort-btn {% if current_sort == 'default' %}active{% endif %}" onclick="changeSort('default')">{{ t.sort_default }}</button>
                <button class="sort-btn {% if current_sort == 'price_asc' %}active{% endif %}" onclick="changeSort('price_asc')">{{ t.sort_price_asc }}</button>
                <button class="sort-btn {% if current_sort == 'price_desc' %}active{% endif %}" onclick="changeSort('price_desc')">{{ t.sort_price_desc }}</button>
            </div>

            <div class="products-grid">
                {% for product in products %}
                <div class="product-card" {% if product.group %}data-group="{{ product.group }}"{% endif %}>
                    <a href="{{ url_prefix }}/products/{{ product.category }}/{{ product.slug }}">
                        <div class="product-image-container">
                            {% if product.images %}
                            <img src="/static/images/products/{{ product.category }}/{{ product.slug }}/thumb_{{ product.images[0].rsplit('.', 1)[0] }}.jpg"
                                 alt="{{ product.title }} - Premium action figure - ${{ '%.2f'|format(product.price) }}"
                                 loading="lazy">
                            {% else %}
                            <div class="product-placeholder">{{ t.no_image }}</div>
                            {% endif %}

                            {# Product badges #}
                            <div class="product-badges">
                                {% if not product.in_stock %}
                                <span class="badge badge-soldout">{{ t.sold_out }}</span>
                                {% endif %}
                                {% if product.is_pre_order %}
                                <span class="badge badge-preorder">{{ t.pre_order }}</span>
                                {% endif %}
                                {% if product.is_on_sale %}
                                <span class="badge badge-sale">{{ t.sale }}</span>
                                {% endif %}
                                {% if product.is_new_arrival %}
                                <span class="badge badge-new">{{ t.new }}</span>
                                {% endif %}
                            </div>

                        </div>

                        <h3>{{ product.zhtw_name if is_zhtw and product.zhtw_name else product.title }}</h3>

                        {# Pricing #}
                        {% if is_zhtw %}
                            {% if product.final_price %}
                            <p class="price">NT${{ product.final_price|ntd }}</p>
                            {% endif %}
                        {% else %}
                            {% if product.is_on_sale and product.sale_price > 0 %}
                            <p class="price">
                                <span class="original-price">${{ "%.2f"|format(product.price) }}</span>
                                <span class="sale-price">${{ "%.2f"|format(product.sale_price) }}</span>
                            </p>
                            {% else %}
                            <p class="price">${{ "%.2f"|format(product.price) }}</p>
                            {% endif %}
                        {% endif %}
                    </a>
                </div>
                {% endfor %}
                {% if not products %}
                <p class="no-products">
                    {% if current_search %}
                    {{ t.no_products_search }} "{{ current_search }}"
                    {% else %}
                    {{ t.no_products_category }}
                    {% endif %}
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// GA4: Track view_item_list on page load
document.addEventListener('DOMContentLoaded', function() {
    if (typeof gtag === 'function') {
        var listName = '{{ current_category_name|default("All Products", true) }}';
        {% if current_tag %}listName = 'Tag: {{ current_tag }}';{% endif %}
        {% if current_search %}listName = 'Search: {{ current_search }}';{% endif %}

        var items = [
            {% for product in products[:20] %}
            {
                item_id: '{{ product.category }}/{{ product.slug }}',
                item_name: '{{ product.title|replace("'", "\\'") }}',
                item_category: '{{ product.category }}',
                price: {{ product.sale_price if product.is_on_sale and product.sale_price else product.price }},
                index: {{ loop.index0 }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        if (items.length > 0) {
            gtag('event', 'view_item_list', {
                item_list_name: listName,
                items: items
            });
        }
    }
});
</script>
{% endblock %}

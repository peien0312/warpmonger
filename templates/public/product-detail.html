{% extends "public/base.html" %}

{% block title %}{{ product.zhtw_name if is_zhtw and product.zhtw_name else product.title }} - {{ category_name }} | Warpmonger{% endblock %}

{% block meta_description %}{% if is_zhtw %}{{ product.zhtw_name or product.title }}{% if product.final_price %} - NT${{ product.final_price|ntd }}{% endif %}{% else %}Buy {{ product.title }} for ${{ "%.2f"|format(product.price) }}. {{ product.description[:150] }}...{% endif %}{% endblock %}

{% block og_type %}product{% endblock %}
{% block og_title %}{{ product.zhtw_name if is_zhtw and product.zhtw_name else product.title }} - {% if is_zhtw and product.final_price %}NT${{ product.final_price|ntd }}{% else %}${{ "%.2f"|format(product.price) }}{% endif %}{% endblock %}
{% block og_description %}{{ product.description[:200] }}{% endblock %}
{% if product.images %}
{% block og_image %}{{ request.url_root }}static/images/products/{{ product.category }}/{{ product.slug }}/{{ product.images[0] }}{% endblock %}
{% endif %}

{% block structured_data %}
<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Product",
  "name": "{{ product.zhtw_name if is_zhtw and product.zhtw_name else product.title }}",
  "description": "{{ product.description|replace('\n', ' ')|replace('"', '\\"') }}",
  {% if product.images %}
  "image": [
    {% for image in product.images %}
    "{{ request.url_root }}static/images/products/{{ product.category }}/{{ product.slug }}/{{ image }}"{% if not loop.last %},{% endif %}
    {% endfor %}
  ],
  {% endif %}
  {% if product.sku %}
  "sku": "{{ product.sku }}",
  {% endif %}
  "brand": {
    "@type": "Brand",
    "name": "Toy Seller"
  },
  "offers": {
    "@type": "Offer",
    "url": "{{ request.url }}",
    "priceCurrency": "{% if is_zhtw %}TWD{% else %}USD{% endif %}",
    "price": "{% if is_zhtw %}{{ product.final_price or 0 }}{% elif product.is_on_sale and product.sale_price > 0 %}{{ product.sale_price }}{% else %}{{ product.price }}{% endif %}",
    "availability": "https://schema.org/{% if product.is_pre_order %}PreOrder{% elif product.in_stock %}InStock{% else %}OutOfStock{% endif %}"
  }
}
</script>

<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Products",
      "item": "{{ request.url_root }}products"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "{{ category_name }}",
      "item": "{{ request.url_root }}products?category={{ product.category }}"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "{{ product.zhtw_name if is_zhtw and product.zhtw_name else product.title }}"
    }
  ]
}
</script>
{% endblock %}

{% block content %}
<!-- Image/Video Lightbox -->
<div id="image-lightbox" class="image-lightbox" onclick="closeLightbox(event)">
    <button class="lightbox-close" onclick="closeLightbox(event)">&times;</button>
    <button class="lightbox-nav lightbox-nav-left" onclick="navigateLightbox(-1, event)">&lt;</button>
    <button class="lightbox-nav lightbox-nav-right" onclick="navigateLightbox(1, event)">&gt;</button>
    <div id="lightbox-content"></div>
</div>

<div class="container">
    <div class="product-detail">
        <div class="product-images">
            {% if product.images %}
                {% set first_file = product.images[0] %}
                {% set is_first_video = first_file.lower().endswith(('.mp4', '.mov', '.avi', '.webm')) %}
                <div class="main-image" onclick="{% if is_first_video %}handleMainImageClick(event){% else %}openLightbox(){% endif %}">
                    {% if is_first_video %}
                    <video id="main-video" controls style="width: 100%; height: 100%; object-fit: contain;">
                        <source src="/static/images/products/{{ product.category }}/{{ product.slug }}/{{ first_file }}" type="video/{{ first_file.split('.')[-1] }}">
                        Your browser does not support the video tag.
                    </video>
                    {% else %}
                    <img id="main-image" src="/static/images/products/{{ product.category }}/{{ product.slug }}/{{ first_file }}"
                         alt="{{ product.title }} - main product image">
                    {% endif %}
                </div>
                {% if product.images|length > 1 %}
                <div class="thumbnails-container">
                    <button class="thumbnail-nav thumbnail-nav-left" onclick="scrollThumbnails(-1)" id="thumb-left-btn">&lt;</button>
                    <div class="image-thumbnails" id="thumbnails-wrapper">
                        {% for image in product.images %}
                        {% if image.lower().endswith(('.mp4', '.mov', '.avi', '.webm')) %}
                        <div class="thumbnail video-thumbnail {% if loop.index0 == 0 %}active{% endif %}"
                             data-index="{{ loop.index0 }}"
                             onclick="switchToMedia({{ loop.index0 }}, this)">
                            <span class="play-icon">â–¶</span>
                        </div>
                        {% else %}
                        <img src="/static/images/products/{{ product.category }}/{{ product.slug }}/{{ image }}"
                             alt="{{ product.title }} - view {{ loop.index }}"
                             data-index="{{ loop.index0 }}"
                             onclick="switchToMedia({{ loop.index0 }}, this)"
                             class="thumbnail {% if loop.index0 == 0 %}active{% endif %}">
                        {% endif %}
                        {% endfor %}
                    </div>
                    <button class="thumbnail-nav thumbnail-nav-right" onclick="scrollThumbnails(1)" id="thumb-right-btn">&gt;</button>
                </div>
                {% endif %}
            {% else %}
                <div class="product-placeholder-large">{{ t.no_image }}</div>
            {% endif %}
        </div>

        <div class="product-info">
            <nav class="breadcrumb">
                <a href="{{ url_prefix }}/products">{{ t.products }}</a> /
                <a href="{{ url_prefix }}/products?category={{ product.category }}">{{ category_name }}</a> /
                <span>{{ product.zhtw_name if is_zhtw and product.zhtw_name else product.title }}</span>
            </nav>

            <h1>{{ product.zhtw_name if is_zhtw and product.zhtw_name else product.title }}</h1>

            {# Product badges #}
            <div class="product-badges-detail">
                {% if not product.in_stock %}
                <span class="badge badge-soldout">{{ t.sold_out }}</span>
                {% endif %}
                {% if product.is_pre_order %}
                <span class="badge badge-preorder">{{ t.pre_order }}</span>
                {% endif %}
                {% if product.is_on_sale %}
                <span class="badge badge-sale">{{ t.sale }}</span>
                {% endif %}
                {% if product.is_new_arrival %}
                <span class="badge badge-new">{{ t.new }}</span>
                {% endif %}
            </div>

            <div class="product-meta">
                {# Pricing #}
                {% if is_zhtw %}
                    {% if product.final_price %}
                    <p class="price">NT${{ product.final_price|ntd }}</p>
                    {% else %}
                    <p class="price contact-price">{{ t.contact_price }}</p>
                    {% endif %}
                {% else %}
                    {% if product.is_on_sale and product.sale_price > 0 %}
                    <p class="price">
                        <span class="original-price">${{ "%.2f"|format(product.price) }}</span>
                        <span class="sale-price">${{ "%.2f"|format(product.sale_price) }}</span>
                        <span class="savings">Save ${{ "%.2f"|format(product.price - product.sale_price) }}</span>
                    </p>
                    {% else %}
                    <p class="price">${{ "%.2f"|format(product.price) }}</p>
                    {% endif %}
                {% endif %}

                {% if product.sku %}
                <p class="sku">{{ t.sku }}: {{ product.sku }}</p>
                {% endif %}

                {# Product Specifications #}
                {% if product.series %}
                <p class="product-spec"><strong>{{ t.series }}:</strong> {{ product.series }}</p>
                {% endif %}
                {% if product.scale %}
                <p class="product-spec"><strong>{{ t.scale }}:</strong> {{ product.scale }}</p>
                {% endif %}
                {% if product.size %}
                <p class="product-spec"><strong>{{ t.size }}:</strong> {{ product.size }}</p>
                {% endif %}
                {% if product.weight %}
                <p class="product-spec"><strong>{{ t.weight }}:</strong> {{ product.weight }}</p>
                {% endif %}

                {# Stock and Pre-order status #}
                {% if product.is_pre_order %}
                <p class="pre-order-status">
                    {{ t.pre_order }}
                    {% if product.available_date %}
                    - {{ t.expected }}: {{ product.available_date|format_month }}
                    {% endif %}
                </p>
                {% else %}
                <p class="stock {% if product.in_stock %}in-stock{% else %}out-of-stock{% endif %}">
                    {% if product.in_stock %}{{ t.in_stock }}{% else %}{{ t.out_of_stock }}{% endif %}
                </p>
                {% endif %}
            </div>

            <!-- Add to Shopping List -->
            <div class="product-actions">
                <div class="quantity-selector">
                    <button type="button" class="qty-btn minus" onclick="updateQty(-1)">-</button>
                    <input type="number" id="product-qty" value="1" min="1" max="99" onchange="validateQty()">
                    <button type="button" class="qty-btn plus" onclick="updateQty(1)">+</button>
                </div>
                <button type="button" class="btn btn-primary btn-lg" id="add-to-cart"
                        data-category="{{ product.category }}"
                        data-slug="{{ product.slug }}"
                        data-title="{{ product.zhtw_name if is_zhtw and product.zhtw_name else product.title }}"
                        data-price="{% if is_zhtw %}{{ product.final_price or 0 }}{% else %}{{ product.sale_price if product.is_on_sale and product.sale_price else product.price }}{% endif %}"
                        data-image="{{ product.images[0] if product.images else '' }}"
                        data-in-stock="{{ 'true' if product.in_stock else 'false' }}"
                        data-pre-order="{{ 'true' if product.is_pre_order else 'false' }}"
                        onclick="addToCart()">
                    {{ t.add_to_list }}
                </button>
            </div>

            <div class="product-description">
                {{ product.description_html|safe }}
            </div>

            {% if product.tags %}
            <div class="product-tags">
                <strong>{{ t.tags_label }}:</strong>
                {% for tag in product.tags %}
                <a href="{{ url_prefix }}/products?tag={{ tag|urlencode }}" class="tag tag-link">{{ tag }}</a>
                {% endfor %}
            </div>
            {% endif %}

        </div>
    </div>

    {# Related Products Carousel - 4 items per row, max 4 rows, arrows navigate 4 at a time #}
    {% if related %}
    <section class="related-products-carousel">
        <div class="related-header">
            <h2>{{ t.related_products }}</h2>
            <div class="related-nav">
                <button class="related-nav-btn prev" onclick="navigateRelated(-1)" aria-label="Previous">&lt;</button>
                <button class="related-nav-btn next" onclick="navigateRelated(1)" aria-label="Next">&gt;</button>
            </div>
        </div>
        <div class="related-grid-container">
            <div class="related-grid" id="related-grid">
                {% for prod in related %}
                <div class="related-card">
                    <a href="{{ url_prefix }}/products/{{ prod.category }}/{{ prod.slug }}">
                        {% if prod.images %}
                        <img src="/static/images/products/{{ prod.category }}/{{ prod.slug }}/thumb_{{ prod.images[0].rsplit('.', 1)[0] }}.jpg"
                             alt="{{ prod.zhtw_name if is_zhtw and prod.zhtw_name else prod.title }}"
                             loading="lazy">
                        {% else %}
                        <div class="product-placeholder">{{ t.no_image }}</div>
                        {% endif %}
                        <h3>{{ prod.zhtw_name if is_zhtw and prod.zhtw_name else prod.title }}</h3>
                        {% if is_zhtw %}
                            {% if prod.final_price %}<p class="price">NT${{ prod.final_price|ntd }}</p>{% endif %}
                        {% else %}
                            <p class="price">${{ "%.2f"|format(prod.price) }}</p>
                        {% endif %}
                    </a>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}
</div>

<script>
// Media list and current index
const mediaList = [
    {% for image in product.images %}
    {
        src: '/static/images/products/{{ product.category }}/{{ product.slug }}/{{ image }}',
        isVideo: {{ 'true' if image.lower().endswith(('.mp4', '.mov', '.avi', '.webm')) else 'false' }},
        type: '{{ image.split('.')[-1] }}'
    }{{ ',' if not loop.last else '' }}
    {% endfor %}
];
let currentMediaIndex = 0;

function handleMainImageClick(e) {
    // Don't open lightbox if clicking on video element itself (controls)
    if (e.target.tagName !== 'VIDEO') {
        openLightbox();
    }
}

function switchToMedia(index, thumbnail) {
    currentMediaIndex = index;
    const media = mediaList[index];
    const mainImageContainer = document.querySelector('.main-image');

    // Remove active class from all thumbnails
    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
    if (thumbnail) thumbnail.classList.add('active');

    if (media.isVideo) {
        mainImageContainer.innerHTML = `
            <video id="main-video" controls style="width: 100%; height: 100%; object-fit: contain;">
                <source src="${media.src}" type="video/${media.type}">
                Your browser does not support the video tag.
            </video>
        `;
        // GA4: Track video play
        var video = mainImageContainer.querySelector('video');
        if (video) {
            video.addEventListener('play', function() {
                if (typeof gtag === 'function' && !this.dataset.tracked) {
                    this.dataset.tracked = 'true';
                    gtag('event', 'video_start', {
                        video_title: '{{ product.title|replace("'", "\\'") }}',
                        video_url: media.src
                    });
                }
            });
        }
        // For videos, only open lightbox when clicking outside the video controls
        mainImageContainer.onclick = (e) => {
            // Don't open lightbox if clicking on video element itself (controls)
            if (e.target.tagName !== 'VIDEO') {
                openLightbox(index);
            }
        };
    } else {
        mainImageContainer.innerHTML = `<img id="main-image" src="${media.src}" alt="Product image">`;
        mainImageContainer.onclick = () => openLightbox(index);
    }
}

function openLightbox(index = null) {
    if (index !== null) currentMediaIndex = index;

    const lightbox = document.getElementById('image-lightbox');
    const lightboxContent = document.getElementById('lightbox-content');
    const media = mediaList[currentMediaIndex];

    if (media.isVideo) {
        lightboxContent.innerHTML = `
            <video controls autoplay style="max-width: 90vw; max-height: 90vh; object-fit: contain;">
                <source src="${media.src}" type="video/${media.type}">
                Your browser does not support the video tag.
            </video>
        `;
    } else {
        lightboxContent.innerHTML = `<img src="${media.src}" alt="Full size image" style="max-width: 90vw; max-height: 90vh; object-fit: contain;">`;
    }

    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeLightbox(e) {
    if (e) {
        e.stopPropagation();
        // Only close if clicking the background, not the content
        if (e.target.id !== 'image-lightbox' && !e.target.classList.contains('lightbox-close')) {
            return;
        }
    }

    // Pause any playing video in the lightbox
    const lightboxContent = document.getElementById('lightbox-content');
    const video = lightboxContent.querySelector('video');
    if (video) {
        video.pause();
    }

    const lightbox = document.getElementById('image-lightbox');
    lightbox.classList.remove('active');
    document.body.style.overflow = '';
}

function navigateLightbox(direction, e) {
    if (e) e.stopPropagation();

    currentMediaIndex += direction;
    if (currentMediaIndex < 0) currentMediaIndex = mediaList.length - 1;
    if (currentMediaIndex >= mediaList.length) currentMediaIndex = 0;

    openLightbox(currentMediaIndex);

    // Update thumbnail active state
    document.querySelectorAll('.thumbnail').forEach((t, i) => {
        t.classList.toggle('active', i === currentMediaIndex);
    });
}

function scrollThumbnails(direction) {
    const wrapper = document.getElementById('thumbnails-wrapper');
    const scrollAmount = wrapper.offsetWidth / 2;
    wrapper.scrollBy({
        left: scrollAmount * direction,
        behavior: 'smooth'
    });
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    const lightbox = document.getElementById('image-lightbox');
    const isLightboxActive = lightbox.classList.contains('active');

    if (e.key === 'Escape' && isLightboxActive) {
        closeLightbox();
    } else if (e.key === 'ArrowLeft' && isLightboxActive) {
        navigateLightbox(-1);
    } else if (e.key === 'ArrowRight' && isLightboxActive) {
        navigateLightbox(1);
    }
});

// Related products carousel - show 4 items at a time, scroll by 4 items
let relatedStartIndex = 0;
const ITEMS_PER_PAGE = 4; // Show 4 items at a time (1 row)

function navigateRelated(direction) {
    const grid = document.getElementById('related-grid');
    if (!grid) return;

    const cards = grid.querySelectorAll('.related-card');
    const totalItems = cards.length;

    // Move by 4 items
    relatedStartIndex += direction * ITEMS_PER_PAGE;

    // Clamp to valid range
    if (relatedStartIndex < 0) relatedStartIndex = 0;
    const maxStart = Math.max(0, totalItems - ITEMS_PER_PAGE);
    if (relatedStartIndex > maxStart) relatedStartIndex = maxStart;

    // Show/hide cards based on current window
    cards.forEach(function(card, index) {
        if (index >= relatedStartIndex && index < relatedStartIndex + ITEMS_PER_PAGE) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });

    // Update button states
    updateRelatedNavButtons(totalItems);
}

function updateRelatedNavButtons(totalItems) {
    var prevBtn = document.querySelector('.related-nav-btn.prev');
    var nextBtn = document.querySelector('.related-nav-btn.next');
    var maxStart = Math.max(0, totalItems - ITEMS_PER_PAGE);

    if (prevBtn) {
        prevBtn.disabled = relatedStartIndex <= 0;
        prevBtn.style.opacity = relatedStartIndex <= 0 ? '0.3' : '1';
    }
    if (nextBtn) {
        nextBtn.disabled = relatedStartIndex >= maxStart;
        nextBtn.style.opacity = relatedStartIndex >= maxStart ? '0.3' : '1';
    }
}

// Initialize related products display on page load
document.addEventListener('DOMContentLoaded', function() {
    var grid = document.getElementById('related-grid');
    if (grid) {
        var cards = grid.querySelectorAll('.related-card');
        // Initially show first 4 items only
        cards.forEach(function(card, index) {
            card.style.display = index < ITEMS_PER_PAGE ? 'block' : 'none';
        });
        updateRelatedNavButtons(cards.length);
    }
});

// Quantity selector functions
function updateQty(delta) {
    var input = document.getElementById('product-qty');
    var newVal = parseInt(input.value) + delta;
    if (newVal >= 1 && newVal <= 99) {
        input.value = newVal;
    }
}

function validateQty() {
    var input = document.getElementById('product-qty');
    var val = parseInt(input.value);
    if (isNaN(val) || val < 1) {
        input.value = 1;
    } else if (val > 99) {
        input.value = 99;
    }
}

// Add to cart function
function addToCart() {
    var btn = document.getElementById('add-to-cart');
    var qty = parseInt(document.getElementById('product-qty').value) || 1;

    var product = {
        category: btn.getAttribute('data-category'),
        slug: btn.getAttribute('data-slug'),
        title: btn.getAttribute('data-title'),
        price: parseFloat(btn.getAttribute('data-price')),
        image: btn.getAttribute('data-image'),
        inStock: btn.getAttribute('data-in-stock') === 'true',
        isPreOrder: btn.getAttribute('data-pre-order') === 'true'
    };

    // GA4: Track add_to_cart
    if (typeof gtag === 'function') {
        gtag('event', 'add_to_cart', {
            currency: document.documentElement.lang === 'zh-TW' ? 'TWD' : 'USD',
            value: product.price * qty,
            items: [{
                item_id: product.category + '/' + product.slug,
                item_name: product.title,
                item_category: product.category,
                price: product.price,
                quantity: qty
            }]
        });
    }

    Cart.addItem(product, qty);
}

// GA4: Track view_item on page load
document.addEventListener('DOMContentLoaded', function() {
    if (typeof gtag === 'function') {
        var btn = document.getElementById('add-to-cart');
        if (btn) {
            gtag('event', 'view_item', {
                currency: document.documentElement.lang === 'zh-TW' ? 'TWD' : 'USD',
                value: parseFloat(btn.getAttribute('data-price')),
                items: [{
                    item_id: btn.getAttribute('data-category') + '/' + btn.getAttribute('data-slug'),
                    item_name: btn.getAttribute('data-title'),
                    item_category: btn.getAttribute('data-category'),
                    price: parseFloat(btn.getAttribute('data-price'))
                }]
            });
        }
    }
});
</script>
<script src="/static/js/codex.js"></script>
{% endblock %}

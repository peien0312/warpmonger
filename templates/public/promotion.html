{% extends "public/base.html" %}

{% block title %}{{ promotion.title }} | Promotions - Warpmonger{% endblock %}

{% block meta_description %}{{ promotion.excerpt or promotion.content[:155] }}...{% endblock %}

{% block og_title %}{{ promotion.title }}{% endblock %}
{% block og_description %}{{ promotion.excerpt or promotion.content[:200] }}{% endblock %}
{% if promotion.banner %}
{% block og_image %}{{ request.url_root[:-1] }}{{ promotion.banner }}{% endblock %}
{% endif %}

{% block content %}
<div class="container">
    <article class="promotion-detail">
        <nav class="breadcrumb">
            <a href="{{ url_prefix }}/promotions">{{ t.promotions }}</a> / <span>{{ promotion.title }}</span>
        </nav>

        {% if promotion.banner %}
        <div class="promotion-banner">
            <img src="{{ promotion.banner }}" alt="{{ promotion.title }}">
        </div>
        {% endif %}

        <header class="promotion-header">
            <h1>{{ promotion.title }}</h1>
            <p class="promo-meta">{{ promotion.date }}</p>
            {% if promotion.active %}
            <span class="promo-badge active">Active Promotion</span>
            {% endif %}
        </header>

        <div class="promotion-content">
            {{ promotion.content_html|safe }}
        </div>

        {% if products %}
        <section class="promotion-products">
            <h2>Featured Products</h2>
            <div class="products-grid">
                {% for product in products %}
                <div class="product-card">
                    <a href="{{ url_prefix }}/products/{{ product.category }}/{{ product.slug }}">
                        <div class="product-image-container">
                            {% if product.images %}
                            <img src="/static/images/products/{{ product.category }}/{{ product.slug }}/thumb_{{ product.images[0].rsplit('.', 1)[0] }}.jpg"
                                 alt="{{ product.title }}"
                                 loading="lazy">
                            {% else %}
                            <div class="product-placeholder">No Image</div>
                            {% endif %}

                            <div class="product-badges">
                                {% if not product.in_stock %}
                                <span class="badge badge-soldout">{{ t.sold_out }}</span>
                                {% endif %}
                                {% if product.is_pre_order %}
                                <span class="badge badge-preorder">{{ t.pre_order }}</span>
                                {% endif %}
                                {% if product.is_on_sale %}
                                <span class="badge badge-sale">{{ t.sale }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <h3>{{ product.zhtw_name if is_zhtw and product.zhtw_name else product.title }}</h3>

                        {% if is_zhtw %}
                            {% if product.final_price %}
                            <p class="price">NT${{ product.final_price|ntd }}</p>
                            {% endif %}
                        {% else %}
                            {% if product.is_on_sale and product.sale_price > 0 %}
                            <p class="price">
                                <span class="original-price">${{ "%.2f"|format(product.price) }}</span>
                                <span class="sale-price">${{ "%.2f"|format(product.sale_price) }}</span>
                            </p>
                            {% else %}
                            <p class="price">${{ "%.2f"|format(product.price) }}</p>
                            {% endif %}
                        {% endif %}
                    </a>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <footer class="promotion-footer">
            <a href="{{ url_prefix }}/promotions" class="btn btn-secondary">{{ t.back_to_promotions }}</a>
        </footer>
    </article>
</div>
{% endblock %}
